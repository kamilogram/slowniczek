<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>S≈Ç√≥wka</title>
  <link rel="icon" type="image/png" href="./favicon.ico">
  <link rel="apple-touch-icon" href="./favicon.ico">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#4facfe">
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
  <!-- Strona startowa z wyborem pakiet√≥w -->
  <div id="start-screen" class="start-screen">
    <div class="start-card">
      <h1>üéØ S≈Ç√≥wka</h1>
      <p class="start-description">Wybierz pakiety s≈Ç√≥wek, kt√≥re chcesz ƒáwiczyƒá lub wklej w≈Çasne:</p>

      <div class="custom-words-container" style="margin-bottom:16px;">
        <label for="custom-words-input"><b>Wklej w≈Çasne s≈Ç√≥wka (array obiekt√≥w hint/answer):</b></label>
        <textarea id="custom-words-input" rows="4" style="width:100%;margin-top:4px;" placeholder='[{"hint":"pies","answer":"dog"},...]'></textarea>
        <div id="custom-words-error" style="color:red;display:none;"></div>
        <div class="remote-sets" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;align-items:center;">
          <input id="remote-set-name" type="text" placeholder="Nazwa zestawu" style="flex:1 1 240px;">
          <button id="btn-save-remote">üíæ Zapisz do API</button>
          <button id="btn-load-remote">‚¨áÔ∏è Za≈Çaduj z API</button>
          <button id="btn-delete-remote">üóë Usu≈Ñ z API</button>
          <select id="remote-sets-list" style="flex:1 1 200px;min-width:200px;">
            <option value="">(lista zestaw√≥w z API)</option>
          </select>
          <button id="btn-refresh-remote">üîÑ Od≈õwie≈º listƒô</button>
        </div>
      </div>

      <div class="package-categories">
        <div class="category">
          <h3>üáµüá± Polski</h3>
          <div class="package-list">
            <label class="package-item">
              <input type="checkbox" id="allWords" data-package="allWords">
              <span class="package-name">Podstawowe s≈Ç√≥wka</span>
              <span class="package-count" id="allWords-count">0 s≈Ç√≥w</span>
            </label>
            <label class="package-item">
              <input type="checkbox" id="allWords2" data-package="allWords2">
              <span class="package-name">Rozszerzone s≈Ç√≥wka</span>
              <span class="package-count" id="allWords2-count">0 s≈Ç√≥w</span>
            </label>
          </div>
        </div>
        <div class="category">
          <h3>üá¨üáß Angielski</h3>
          <div class="package-list">
            <label class="package-item">
              <input type="checkbox" id="allWordsEnglish" data-package="allWordsEnglish">
              <span class="package-name">Angielskie s≈Ç√≥wka</span>
              <span class="package-count" id="allWordsEnglish-count">0 s≈Ç√≥w</span>
            </label>
          </div>
        </div>
        <div class="category">
          <h3>üá¨üáß Angielski - Rozszerzone</h3>
          <div class="package-list">
            <label class="package-item">
              <input type="checkbox" id="easiest" data-package="easiest">
              <span class="package-name">Naj≈Çatwiejsze</span>
              <span class="package-count" id="easiest-count">0 s≈Ç√≥w</span>
            </label>
            <label class="package-item">
              <input type="checkbox" id="stillEasy" data-package="stillEasy">
              <span class="package-name">WciƒÖ≈º ≈Çatwe</span>
              <span class="package-count" id="stillEasy-count">0 s≈Ç√≥w</span>
            </label>
            <label class="package-item">
              <input type="checkbox" id="harder" data-package="harder">
              <span class="package-name">Trudniejsze</span>
              <span class="package-count" id="harder-count">0 s≈Ç√≥w</span>
            </label>
            <label class="package-item">
              <input type="checkbox" id="advanced" data-package="advanced">
              <span class="package-name">Zaawansowane</span>
              <span class="package-count" id="advanced-count">0 s≈Ç√≥w</span>
            </label>
          </div>
        </div>
      </div>

      <div class="start-actions" style="margin-top:24px;">
        <button id="start-btn" class="start-btn" disabled>Rozpocznij</button>
        <p class="selected-info" id="selected-info">Wybierz co najmniej jeden pakiet</p>
      </div>
    </div>
  </div>

  <!-- G≈Ç√≥wna aplikacja (poczƒÖtkowo ukryta) -->
  <div id="main-app" class="main-app" style="display: none;">
    <div class="card">
      <p id="last-word"></p>
      <p id="progress"></p>
      <h2 id="hint">≈Åadowanie...</h2>
      <p id="answer"></p>
    
    <div class="buttons">
      <button onclick="skipWord()">Poka≈º</button>
      <button onclick="nextWord()">Wiem</button>
      <button onclick="restart()" id="restart-btn" style="display:none;">Jeszcze raz</button>
    </div>
    
    <div class="center-buttons">
      <button id="undo-known-btn">Jednak nie wiedzia≈Çem</button>
    </div>
    <div class="center-buttons gap">
      <button id="auto-mode-btn">Auto tryb</button>
      <button id="toggle-dark-mode-btn">Tryb nocny</button>
    </div>
    <div class="center-buttons margin-top-small" id="lang-select-container" style="display:none;">
      <label for="hint-lang-select">Jƒôzyk podpowiedzi:</label>
      <select id="hint-lang-select">
        <option value="pl-PL">Polski</option>
        <option value="en-US">Angielski</option>
      </select>
      <label for="answer-lang-select">Jƒôzyk odpowiedzi:</label>
      <select id="answer-lang-select">
        <option value="en-US">Angielski</option>
        <option value="pl-PL">Polski</option>
      </select>
    </div>
    <div class="center-buttons" id="other-options-btn-container">
      <button id="other-options-btn">Inne opcje</button>
    </div>
    <div class="memory-buttons" id="memory-buttons" style="display:none;">
  <button id="save-word-btn">Dodaj poprzednie</button>
  <button id="save-current-btn">Dodaj aktualne</button>
  <button id="show-memory-btn">Poka≈º zapamiƒôtane</button>
  <button id="save-selected-btn">Dodaj zaznaczone</button>
  <button id="save-global-selection-btn">Dodaj aktualnie zaznaczony tekst</button>
    </div>
    <div id="memory-list" style="display:none;"></div>
    
    <div class="center-buttons margin-top-small">
      <button id="change-packages-btn" class="change-packages-btn">üì¶ Zmie≈Ñ pakiety</button>
    </div>
    
    <div id="auto-timer"></div>
    
    <div class="search-container" id="search-container" style="display:none;">
      <input type="text" id="search-input" placeholder="üîç Wyszukaj s≈Ç√≥wko...">
      <button onclick="searchWord()" class="search-btn">
        <span>üîç</span>
      </button>
    </div>
    <div id="search-results" style="display:none;">
      <p class="search-results-placeholder">Wyniki wyszukiwania pojawiƒÖ siƒô tutaj...</p>
    </div>
    
    <div class="center-buttons margin-top-small">
      <button id="clear-used-btn">Wyczy≈õƒá odgadniƒôte s≈Ç√≥wka</button>
    </div>
  </div>
  
  <!-- Dodanie skrypt√≥w dla nowych plik√≥w s≈Ç√≥wek -->
  <script src="english/easiest.js"></script>
  <script src="english/stillEasy.js"></script>
  <script src="english/harder.js"></script>
  <script src="english/advanced.js"></script>
  
  <script src="allWords.js"></script>
  <script src="allWords2.js"></script>
  <script src="allWordsEnglish.js"></script>
  <script>
// --- API config ---
const API_BASE = 'https://slowka-backend.onrender.com';
// --- Zaznaczanie fragmentu tekstu ---
let selectedFragment = null;
function getSelectedTextInElement(element) {
  const selection = window.getSelection();
  if (!selection || selection.rangeCount === 0) return null;
  const range = selection.getRangeAt(0);
  if (!element.contains(range.commonAncestorContainer)) return null;
  return selection.toString().trim();
}
function handleFragmentSelection(type, element) {
  const text = getSelectedTextInElement(element);
  if (text) {
    selectedFragment = {type, text};
    element.classList.add('highlight-selected');
    if (type === 'hint') document.getElementById('answer').classList.remove('highlight-selected');
    if (type === 'answer') document.getElementById('hint').classList.remove('highlight-selected');
  }
}
document.getElementById('hint').addEventListener('mouseup', function() {
  handleFragmentSelection('hint', this);
});
document.getElementById('answer').addEventListener('mouseup', function() {
  handleFragmentSelection('answer', this);
});
// Obs≈Çuga dotyku na smartfonach
document.getElementById('hint').addEventListener('touchend', function() {
  setTimeout(() => handleFragmentSelection('hint', this), 100);
});
document.getElementById('answer').addEventListener('touchend', function() {
  setTimeout(() => handleFragmentSelection('answer', this), 100);
});
function clearSelectedHighlight() {
  document.getElementById('hint').classList.remove('highlight-selected');
  document.getElementById('answer').classList.remove('highlight-selected');
  selectedFragment = null;
  window.getSelection().removeAllRanges();
}
// Przycisk do dodawania dowolnie zaznaczonego tekstu (np. na mobilnych)
window.addEventListener('DOMContentLoaded', function() {
  const globalBtn = document.getElementById('save-global-selection-btn');
  if (globalBtn) {
    globalBtn.onclick = function() {
      const selection = window.getSelection();
      const text = selection ? selection.toString().trim() : '';
      if (!text) return alert('Nie zaznaczono tekstu!');
      // Spr√≥buj okre≈õliƒá typ na podstawie miejsca zaznaczenia
      let type = null;
      const hintEl = document.getElementById('hint');
      const answerEl = document.getElementById('answer');
      if (hintEl.contains(selection.anchorNode)) type = 'hint';
      else if (answerEl.contains(selection.anchorNode)) type = 'answer';
      else type = 'other';
      const fragMem = getFragmentMemory();
      if (!fragMem.some(w => w.text === text && w.type === type)) {
        fragMem.push({text, type});
        setFragmentMemory(fragMem);
        this.classList.add('highlight-green');
        setTimeout(() => {
          this.classList.remove('highlight-green');
        }, 2000);
        clearSelectedHighlight();
        // Aktualizuj listƒô fragment√≥w po przecinku je≈õli jest widoczna
        const fragList = document.getElementById('fragment-memory-list-comma');
        if (fragList && fragList.style.display !== 'none') {
          renderFragmentMemoryComma();
        }
      } else {
        alert('Ten fragment ju≈º jest w pamiƒôci.');
      }
    };
  }
});
    // Zmienne globalne
    let allPackages = {}; // Wszystkie dostƒôpne pakiety
    let selectedPackages = []; // Wybrane pakiety
    let combinedWords = []; // Po≈ÇƒÖczone wybrane pakiety
    let pool = [];
    let used = [];
    let current = null;
    let previous = null;
    let isListening = false;
    let wasSkipped = false;
    let autoMode = false;
    let autoTimer = null;
    let autoStep = 0;
    let autoTimeLeft = 0;
    let speakHintActive = false;
    let voiceRate = 1.0;

        // ...usuniƒôto generator bia≈Çego szumu...

    // --- Inicjalizacja pakiet√≥w ---
    function initializePackages() {
      // Zbierz wszystkie dostƒôpne pakiety
      allPackages = {
        allWords: window.allWords || [],
        allWords2: window.allWords2 || [],
        allWordsEnglish: window.allWordsEnglish || [],
        easiest: window.easiest || [],
        stillEasy: window.stillEasy || [],
        harder: window.harder || [],
        advanced: window.advanced || []
      };
      
      // Aktualizuj liczniki s≈Ç√≥w
      updatePackageCounts();
      
      // Za≈Çaduj zapisane wybory
      loadSavedPackages();
      
      // Dodaj event listeners
      setupPackageSelection();

      // Prefill i autozapis w≈Çasnych s≈Ç√≥wek
      const customInput = document.getElementById('custom-words-input');
      if (customInput) {
        // Je≈õli w storage sƒÖ zapisane s≈Ç√≥wka i pole jest puste ‚Äì wype≈Çnij je
        try {
          const savedCustom = JSON.parse(localStorage.getItem('slowkaCustomWords') || '[]');
          if (Array.isArray(savedCustom) && savedCustom.length > 0 && !customInput.value.trim()) {
            customInput.value = JSON.stringify(savedCustom);
          }
        } catch (_) {}

        // Autouzup. stanu przy starcie
        updateStartButton();

        // Autosejw przy wpisywaniu (z prostƒÖ walidacjƒÖ)
        customInput.addEventListener('input', function() {
          const val = customInput.value.trim();
          if (!val) {
            localStorage.removeItem('slowkaCustomWords');
            document.getElementById('custom-words-error').style.display = 'none';
            updateStartButton();
            return;
          }
          let arr = null;
          try {
            arr = JSON.parse(val);
          } catch (e) {
            try { arr = JSON.parse(val.replace(/'/g, '"')); } catch (e2) { arr = null; }
          }
          if (Array.isArray(arr)) {
            const valid = arr.filter(o => o && typeof o.hint === 'string' && typeof o.answer === 'string');
            if (valid.length > 0) {
              localStorage.setItem('slowkaCustomWords', JSON.stringify(valid));
              document.getElementById('custom-words-error').style.display = 'none';
            } else {
              localStorage.removeItem('slowkaCustomWords');
            }
          }
          updateStartButton();
        });
      }

      // Inicjalizacja UI API
      setupRemoteSetsUI();
    }
    
    function updatePackageCounts() {
      const allWordsCount = document.getElementById('allWords-count');
      const allWords2Count = document.getElementById('allWords2-count');
      const allWordsEnglishCount = document.getElementById('allWordsEnglish-count');
      const easiestCount = document.getElementById('easiest-count');
      const stillEasyCount = document.getElementById('stillEasy-count');
      const harderCount = document.getElementById('harder-count');
      const advancedCount = document.getElementById('advanced-count');
      
      if (allWordsCount) allWordsCount.textContent = `${allPackages.allWords.length} s≈Ç√≥w`;
      if (allWords2Count) allWords2Count.textContent = `${allPackages.allWords2.length} s≈Ç√≥w`;
      if (allWordsEnglishCount) allWordsEnglishCount.textContent = `${allPackages.allWordsEnglish.length} s≈Ç√≥w`;
      if (easiestCount) easiestCount.textContent = `${allPackages.easiest.length} s≈Ç√≥w`;
      if (stillEasyCount) stillEasyCount.textContent = `${allPackages.stillEasy.length} s≈Ç√≥w`;
      if (harderCount) harderCount.textContent = `${allPackages.harder.length} s≈Ç√≥w`;
      if (advancedCount) advancedCount.textContent = `${allPackages.advanced.length} s≈Ç√≥w`;
    }
    
    function loadSavedPackages() {
      const saved = localStorage.getItem('slowkaSelectedPackages');
      if (saved) {
        selectedPackages = JSON.parse(saved);
        // Zaznacz zapisane pakiety
        selectedPackages.forEach(pkg => {
          const checkbox = document.getElementById(pkg);
          if (checkbox) checkbox.checked = true;
        });
        updateStartButton();
      }
    }
    
    function setupPackageSelection() {
      // Event listeners dla checkbox√≥w
      document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', updateStartButton);
      });
      
      // Event listener dla przycisku start
      document.getElementById('start-btn').addEventListener('click', startApplication);
      
      // Event listener dla przycisku zmiany pakiet√≥w
      document.getElementById('change-packages-btn').addEventListener('click', showPackageSelection);
    }
    
    function updateStartButton() {
      const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
      const startBtn = document.getElementById('start-btn');
      const selectedInfo = document.getElementById('selected-info');
      const customInput = document.getElementById('custom-words-input');
      let customCount = 0;
      if (customInput && customInput.value.trim()) {
        let arr = null;
        let input = customInput.value.trim();
        try {
          arr = JSON.parse(input);
        } catch (e) {
          if (input.startsWith('[') && input.endsWith(']')) {
            let evalInput = input.replace(/\n/g, ' ').replace(/\r/g, ' ');
            try {
              arr = eval(evalInput);
            } catch (err) {
              try {
                let jsonLike = input.replace(/'/g, '"');
                arr = JSON.parse(jsonLike);
              } catch (err2) {
                arr = null;
              }
            }
          }
        }
        if (Array.isArray(arr)) {
          customCount = arr.filter(obj => obj && typeof obj.hint === 'string' && typeof obj.answer === 'string').length;
        }
      } else {
        // Je≈õli pole puste, sprawd≈∫ lokalny storage
        try {
          const saved = JSON.parse(localStorage.getItem('slowkaCustomWords') || '[]');
          if (Array.isArray(saved)) customCount = saved.length;
        } catch (_) {}
      }
      if (checkboxes.length > 0 || customCount > 0) {
        startBtn.disabled = false;
        const totalWords = Array.from(checkboxes).reduce((total, checkbox) => {
          const packageName = checkbox.id;
          return total + (allPackages[packageName] ? allPackages[packageName].length : 0);
        }, 0);
        if (checkboxes.length > 0 && customCount > 0) {
          selectedInfo.textContent = `Wybrano ${checkboxes.length} pakiet(√≥w) - ${totalWords} s≈Ç√≥w + ${customCount} w≈Çasnych`;
        } else if (checkboxes.length > 0) {
          selectedInfo.textContent = `Wybrano ${checkboxes.length} pakiet(√≥w) - ${totalWords} s≈Ç√≥w`;
        } else {
          selectedInfo.textContent = `W≈Çasne s≈Ç√≥wka: ${customCount}`;
        }
      } else {
        startBtn.disabled = true;
        selectedInfo.textContent = 'Wybierz co najmniej jeden pakiet lub wklej w≈Çasne s≈Ç√≥wka';
      }
    }
    
    function startApplication() {
      // Zbierz wybrane pakiety
      selectedPackages = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
        .map(checkbox => checkbox.id);
      
      // Zapisz wyb√≥r
      localStorage.setItem('slowkaSelectedPackages', JSON.stringify(selectedPackages));
      
      // Po≈ÇƒÖcz wybrane pakiety
      combineSelectedPackages();
      
  // Ukryj stronƒô startowƒÖ i poka≈º aplikacjƒô
  document.getElementById('start-screen').style.display = 'none';
  document.getElementById('main-app').style.display = 'block';
  // P≈Çynnie przewi≈Ñ na g√≥rƒô strony
  window.scrollTo({ top: 0, behavior: 'smooth' });
  // Inicjalizuj aplikacjƒô
  initializeApp();
    }
    
    // ...usuniƒôto funkcjƒô czytania na g≈Ços...

    // --- Aktualizacja struktury s≈Ç√≥wek ---
    function combineSelectedPackages() {
      combinedWords = [];
      selectedPackages.forEach(packageName => {
        if (allPackages[packageName]) {
          allPackages[packageName].forEach(word => {
            combinedWords.push({
              ...word,
              hintLanguage: packageName === 'allWords' || packageName === 'allWords2' ? 'pl' : 'en',
              answerLanguage: packageName === 'allWords' || packageName === 'allWords2' ? 'pl' : 'en'
            });
          });
        }
      });

      // Dodaj w≈Çasne s≈Ç√≥wka je≈õli sƒÖ
      const customInput = document.getElementById('custom-words-input');
      const customError = document.getElementById('custom-words-error');
      customError.style.display = 'none';
      if (customInput && customInput.value.trim()) {
        let arr = null;
        let input = customInput.value.trim();
        // Spr√≥buj najpierw JSON.parse
        try {
          arr = JSON.parse(input);
        } catch (e) {
          // Je≈õli nie jest JSON, spr√≥buj eval je≈õli wyglƒÖda jak array JS
          if (input.startsWith('[') && input.endsWith(']')) {
            // Usu≈Ñ nowe linie i nadmiarowe spacje
            let evalInput = input.replace(/\n/g, ' ').replace(/\r/g, ' ');
            try {
              arr = eval(evalInput);
            } catch (err) {
              // Spr√≥buj zamieniƒá pojedyncze cudzys≈Çowy na podw√≥jne i ponowiƒá JSON.parse
              try {
                let jsonLike = input.replace(/'/g, '"');
                arr = JSON.parse(jsonLike);
              } catch (err2) {
                customError.textContent = 'B≈ÇƒÖd parsowania tablicy: ' + err2.message;
                customError.style.display = 'block';
              }
            }
          } else {
            customError.textContent = 'Wklej poprawnƒÖ tablicƒô obiekt√≥w!';
            customError.style.display = 'block';
          }
        }
        if (Array.isArray(arr)) {
          arr.forEach(obj => {
            if (obj && typeof obj.hint === 'string' && typeof obj.answer === 'string') {
              combinedWords.push({
                hint: obj.hint,
                answer: obj.answer,
                hintLanguage: 'pl',
                answerLanguage: 'en',
                source: 'custom'
              });
            }
          });
          // Zapisz poprawnie sparsowane w≈Çasne s≈Ç√≥wka do localStorage
          try { localStorage.setItem('slowkaCustomWords', JSON.stringify(arr)); } catch (_) {}
        } else if (arr !== null) {
          customError.textContent = 'Wklej poprawnƒÖ tablicƒô obiekt√≥w!';
          customError.style.display = 'block';
        }
      } else {
        // Je≈õli pole jest puste, ale sƒÖ zapisane w≈Çasne s≈Ç√≥wka ‚Äì do≈ÇƒÖcz je
        try {
          const saved = JSON.parse(localStorage.getItem('slowkaCustomWords') || '[]');
          if (Array.isArray(saved) && saved.length > 0) {
            saved.forEach(obj => {
              if (obj && typeof obj.hint === 'string' && typeof obj.answer === 'string') {
                combinedWords.push({
                  hint: obj.hint,
                  answer: obj.answer,
                  hintLanguage: 'pl',
                  answerLanguage: 'en',
                  source: 'custom'
                });
              }
            });
          }
        } catch (_) {}
      }

      // Ustaw window.allWords dla kompatybilno≈õci
      window.allWords = combinedWords;
    }
    
    function showPackageSelection() {
      // Zatrzymaj aplikacjƒô je≈õli dzia≈Ça
      if (autoMode) {
        stopAutoMode();
      }
      
      // Poka≈º stronƒô startowƒÖ
      document.getElementById('main-app').style.display = 'none';
      document.getElementById('start-screen').style.display = 'flex';
      
      // Zaktualizuj przycisk start
      updateStartButton();
      // Od≈õwie≈º listƒô zestaw√≥w z API gdy wracamy do ekranu startowego
      refreshRemoteSetsList();
    }
    
    function initializeApp() {
      // Inicjalizacja puli i statystyki
      used = getUsedWords();
      pool = combinedWords.filter(w => !used.some(u => u.answer === w.answer && u.hint === w.hint));
      
      // Poka≈º pierwsze s≈Çowo
      showWord();
    }

    // --- Remote sets (API) ---
    function getCustomWordsArrayFromTextarea() {
      const el = document.getElementById('custom-words-input');
      if (!el) return [];
      const val = el.value.trim();
      if (!val) return [];
      // 1) Surowy JSON
      try { return JSON.parse(val) || []; } catch (_) {}
      // 2) JSON z pojedynczymi cudzys≈Çowami i niecytowanymi kluczami hint/answer
      try {
        const normalized = val
          .replace(/'(.*?)'/g, '"$1"')
          .replace(/\b(hint|answer)\s*:/g, '"$1":');
        const parsed = JSON.parse(normalized);
        if (Array.isArray(parsed)) return parsed;
      } catch (_) {}
      // 3) Prosty format linijkowy: "hint - answer" / "hint;answer" / "hint,answer" / "hint -> answer"
      const lines = val.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
      const pairs = [];
      for (const line of lines) {
        if (line.startsWith('#')) continue; // komentarze
        const m = line.split(/\s*(?:-|;|,|->)\s*/);
        if (m.length >= 2) {
          const hint = m[0];
          const answer = m.slice(1).join(' ');
          if (hint && answer) pairs.push({ hint, answer });
        }
      }
      return pairs;
    }

    function setCustomWordsArrayToTextarea(arr) {
      const el = document.getElementById('custom-words-input');
      if (!el) return;
      el.value = JSON.stringify(arr, null, 2);
      // Zapisz lokalnie te≈º
      try { localStorage.setItem('slowkaCustomWords', JSON.stringify(arr)); } catch (_) {}
      updateStartButton();
    }

    async function refreshRemoteSetsList() {
      const list = document.getElementById('remote-sets-list');
      if (!list) return;
      list.innerHTML = '<option value="">(≈Çadowanie...)</option>';
      try {
        const resp = await fetch(`${API_BASE}/api/sets`);
        const data = await resp.json();
        const names = Array.isArray(data.names) ? data.names : [];
        list.innerHTML = '<option value="">(lista zestaw√≥w z API)</option>' +
          names.map(n => `<option value="${n}">${n}</option>`).join('');
      } catch (e) {
        list.innerHTML = '<option value="">(b≈ÇƒÖd pobierania listy)</option>';
      }
    }

    function setupRemoteSetsUI() {
      const btnRefresh = document.getElementById('btn-refresh-remote');
      const btnSave = document.getElementById('btn-save-remote');
      const btnLoad = document.getElementById('btn-load-remote');
      const btnDelete = document.getElementById('btn-delete-remote');
      const nameInput = document.getElementById('remote-set-name');
      const list = document.getElementById('remote-sets-list');
      if (!btnRefresh || !btnSave || !btnLoad || !btnDelete || !nameInput || !list) return;

      btnRefresh.onclick = refreshRemoteSetsList;
      refreshRemoteSetsList();

      btnSave.onclick = async function() {
        const name = (nameInput.value || '').trim() || list.value;
        if (!name) return alert('Podaj nazwƒô zestawu.');
        const words = getCustomWordsArrayFromTextarea();
        const valid = words.filter(o => o && typeof o.hint === 'string' && typeof o.answer === 'string' && o.hint && o.answer);
        if (!valid.length) return alert('Brak s≈Ç√≥wek do zapisania. U≈ºyj np. linii "pies - dog" lub tablicy [{"hint":"pies","answer":"dog"}].');
        try {
          const resp = await fetch(`${API_BASE}/api/sets/${encodeURIComponent(name)}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ words: valid })
          });
          const data = await resp.json();
          if (!resp.ok) throw new Error(data && data.error ? data.error : 'B≈ÇƒÖd zapisu');
          alert(`Zapisano zestaw "${name}" (${data.count} s≈Ç√≥w).`);
          refreshRemoteSetsList();
        } catch (e) {
          alert('B≈ÇƒÖd zapisu: ' + e.message);
        }
      };

      btnLoad.onclick = async function() {
        const name = list.value || (nameInput.value || '').trim();
        if (!name) return alert('Wybierz lub wpisz nazwƒô zestawu.');
        try {
          const resp = await fetch(`${API_BASE}/api/sets/${encodeURIComponent(name)}`);
          const data = await resp.json();
          if (!resp.ok) throw new Error(data && data.error ? data.error : 'B≈ÇƒÖd pobierania');
          if (!Array.isArray(data.words)) throw new Error('Nieprawid≈Çowy format danych');
          setCustomWordsArrayToTextarea(data.words);
          alert(`Za≈Çadowano zestaw "${name}" (${data.words.length} s≈Ç√≥w).`);
        } catch (e) {
          alert('B≈ÇƒÖd pobierania: ' + e.message);
        }
      };

      btnDelete.onclick = async function() {
        const name = list.value || (nameInput.value || '').trim();
        if (!name) return alert('Wybierz lub wpisz nazwƒô zestawu.');
        if (!confirm(`UsunƒÖƒá zestaw "${name}" z API?`)) return;
        try {
          const resp = await fetch(`${API_BASE}/api/sets/${encodeURIComponent(name)}`, { method: 'DELETE' });
          if (!resp.ok) throw new Error('B≈ÇƒÖd usuwania');
          alert(`Usuniƒôto zestaw "${name}".`);
          refreshRemoteSetsList();
        } catch (e) {
          alert('B≈ÇƒÖd usuwania: ' + e.message);
        }
      };
    }

    function updateProgress() {
      document.getElementById("progress").textContent = `S≈Ç√≥wko ${used.length + 1} z ${combinedWords.length}`;
    }

    function showWord() {
      if (pool.length === 0) {
        document.getElementById("hint").textContent = "üéâ Uko≈Ñczy≈Çe≈õ wszystkie s≈Ç√≥wka!";
        document.getElementById("hint").className = "";
        document.getElementById("answer").textContent = "";
        document.getElementById("answer").style.visibility = "hidden";
        document.getElementById("progress").textContent = "";
        document.getElementById("last-word").textContent = "";
        document.getElementById("restart-btn").style.display = "inline-block";
        if (autoMode) stopAutoMode(); // wy≈ÇƒÖcz tryb automatyczny po uko≈Ñczeniu
        return;
      }
      document.getElementById("restart-btn").style.display = "none";
      const index = Math.floor(Math.random() * pool.length);
      current = pool[index];
      wasSkipped = false;
      
      const hintElement = document.getElementById("hint");
      hintElement.textContent = current.hint;
      
      // Apply styling based on word source
      if (current.source === 'allWordsEnglish') {
        hintElement.className = 'english-hint';
      } else {
        hintElement.className = '';
      }
      
      document.getElementById("answer").textContent = current.answer;
      document.getElementById("answer").style.visibility = "hidden";
      updateProgress();
      // Czytaj hint na g≈Ços tylko w trybie auto
      if (autoMode) {
        const hintLang = document.getElementById('hint-lang-select').value;
        if (current.hint) {
          const utterHint = new window.SpeechSynthesisUtterance(current.hint);
          utterHint.lang = hintLang;
          utterHint.volume = 0.8;
          utterHint.rate = 1.0;
          window.speechSynthesis.speak(utterHint);
        }
      }
    }
    // --- Nowa funkcja czytania na g≈Ços ---
    function speakCurrent() {
      const hintLang = document.getElementById('hint-lang-select').value;
      const answerLang = document.getElementById('answer-lang-select').value;
      if (!current) return;
      // Czytaj hint
      if (current.hint) {
        const utterHint = new window.SpeechSynthesisUtterance(current.hint);
        utterHint.lang = hintLang;
        utterHint.volume = 0.8;
        utterHint.rate = 1.0;
        window.speechSynthesis.speak(utterHint);
      }
      // Czytaj answer
      if (current.answer) {
        const utterAnswer = new window.SpeechSynthesisUtterance(current.answer);
        utterAnswer.lang = answerLang;
        utterAnswer.volume = 0.8;
        utterAnswer.rate = 1.0;
        window.speechSynthesis.speak(utterAnswer);
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      const speakBtn = document.getElementById('speak-btn');
      if (speakBtn) speakBtn.onclick = speakCurrent;
    });

    function skipWord() {
      wasSkipped = true;
      document.getElementById("answer").style.visibility = "visible";
      document.querySelector('button[onclick="nextWord()"]').textContent = "Dalej";
      // Czytaj answer na g≈Ços tylko w trybie auto
      if (autoMode) {
        const answerLang = document.getElementById('answer-lang-select').value;
        if (current.answer) {
          const utterAnswer = new window.SpeechSynthesisUtterance(current.answer);
          utterAnswer.lang = answerLang;
          utterAnswer.volume = 0.8;
          utterAnswer.rate = 1.0;
          window.speechSynthesis.speak(utterAnswer);
        }
      }
    }

    function nextWord() {
      if (!wasSkipped) {
        previous = current;
        document.getElementById("last-word").innerHTML = `Poprzednie has≈Ço: <span class='last-word-green'>${previous.answer}</span>`;
        pool = pool.filter(w => w !== current);
        used.push(current);
        setUsedWords(used);
      } else {
        previous = current;
        document.getElementById("last-word").innerHTML = `Poprzednie has≈Ço: <span class='last-word-green'>${previous.answer}</span>`;
      }
      wasSkipped = false;
      document.querySelector('button[onclick="nextWord()"]').textContent = "Wiem";
      showWord();
    }

    function restart() {
      setUsedWords([]); // Wyczy≈õƒá historiƒô odgadniƒôtych s≈Ç√≥wek
      used = [];
      pool = [...combinedWords];
      previous = null;
      wasSkipped = false;
      document.getElementById("restart-btn").style.display = "none";
      document.getElementById("progress").textContent = "";
      document.getElementById("last-word").textContent = "";
      document.getElementById("answer").style.visibility = "hidden";
      document.querySelector('button[onclick="nextWord()"]').textContent = "Wiem";
      showWord();
      if (isListening) recognition.start();
    }

    let touchStartX = 0;
    document.addEventListener("touchstart", e => {
      touchStartX = e.changedTouches[0].screenX;
    });
    document.addEventListener("touchend", e => {
      const deltaX = e.changedTouches[0].screenX - touchStartX;
      if (Math.abs(deltaX) > 50) {
        if (deltaX < 0) {
          nextWord(); // przesuniƒôcie w lewo
        } else {
          skipWord(); // przesuniƒôcie w prawo
        }
      }
    });

    // --- Pamiƒôƒá s≈Ç√≥wek ---
// --- Pamiƒôƒá fragment√≥w ---
function getFragmentMemory() {
  return JSON.parse(localStorage.getItem('slowkaFragmentMemory') || '[]');
}
function setFragmentMemory(arr) {
  localStorage.setItem('slowkaFragmentMemory', JSON.stringify(arr));
}

function renderFragmentMemoryComma() {
  const mem = getFragmentMemory();
  const list = document.getElementById('fragment-memory-list-comma');
  if (!list) return;
  if (!mem.length) {
    list.textContent = 'Brak zapamiƒôtanych fragment√≥w.';
    list.style.display = 'block';
    return;
  }
  list.textContent = mem.map(w => w.text).join(', ');
  list.style.display = 'block';
}

function removeFragmentMemory(idx) {
  const mem = getFragmentMemory();
  mem.splice(idx,1);
  setFragmentMemory(mem);
  renderFragmentMemory();
}
    function getMemory() {
      return JSON.parse(localStorage.getItem('slowkaMemory') || '[]');
    }
    
    function setMemory(arr) {
      localStorage.setItem('slowkaMemory', JSON.stringify(arr));
    }

    // --- Zapamiƒôtywanie odgadniƒôtych s≈Ç√≥wek ---
    function getUsedWords() {
      return JSON.parse(localStorage.getItem('slowkaUsed') || '[]');
    }
    
    function setUsedWords(arr) {
      localStorage.setItem('slowkaUsed', JSON.stringify(arr));
    }



function renderMemory() {
  const mem = getMemory();
  const list = document.getElementById('memory-list');
  if (!mem.length) {
    list.innerHTML = '<em>Brak zapamiƒôtanych s≈Ç√≥wek.</em>';
    return;
  }
  list.innerHTML = mem.map((w,i) => {
    if (w.type === 'hint') {
      return `<div class='memory-item'><div class='memory-item-content'><b>${w.answer}</b> <span class='memory-type'>(z podpowiedzi)</span></div><button onclick='removeMemory(${i})'>Usu≈Ñ</button></div>`;
    } else if (w.type === 'answer') {
      return `<div class='memory-item'><div class='memory-item-content'><b>${w.answer}</b> <span class='memory-type'>(z odpowiedzi)</span></div><button onclick='removeMemory(${i})'>Usu≈Ñ</button></div>`;
    } else {
      return `<div class='memory-item'><div class='memory-item-content'><b>${w.answer}</b> <span>${w.hint}</span></div><button onclick='removeMemory(${i})'>Usu≈Ñ</button></div>`;
    }
  }).join('');
}
    
    function removeMemory(idx) {
      const mem = getMemory();
      mem.splice(idx,1);
      setMemory(mem);
      renderMemory();
    }
    
document.getElementById('save-selected-btn').onclick = function() {
  if (!selectedFragment || !selectedFragment.text) return alert('Nie zaznaczono fragmentu! Zaznacz fragment tekstu w podpowiedzi lub odpowiedzi.');
  const fragMem = getFragmentMemory();
  if (!fragMem.some(w => w.text === selectedFragment.text && w.type === selectedFragment.type)) {
    fragMem.push({text: selectedFragment.text, type: selectedFragment.type});
    setFragmentMemory(fragMem);
    this.classList.add('highlight-green');
    setTimeout(() => {
      this.classList.remove('highlight-green');
    }, 2000);
    clearSelectedHighlight();
    // Aktualizuj listƒô fragment√≥w po przecinku je≈õli jest widoczna
    const fragList = document.getElementById('fragment-memory-list-comma');
    if (fragList && fragList.style.display !== 'none') {
      renderFragmentMemoryComma();
    }
  } else {
    alert('Ten fragment ju≈º jest w pamiƒôci.');
  }
};

    
    document.getElementById('save-current-btn').onclick = function() {
      if (!current) return alert('Brak aktualnego s≈Çowa!');
      const mem = getMemory();
      if (!mem.some(w => w.answer === current.answer && w.hint === current.hint)) {
        mem.push({answer: current.answer, hint: current.hint});
        setMemory(mem);
        const btn = this;
        btn.classList.add('highlight-green');
        setTimeout(() => {
          btn.classList.remove('highlight-green');
        }, 2000);
      } else {
        alert('To s≈Çowo ju≈º jest w pamiƒôci.');
      }
    };
    
    let memoryVisible = false;
    document.getElementById('show-memory-btn').onclick = function() {
      memoryVisible = !memoryVisible;
      const memoryList = document.getElementById('memory-list');
      memoryList.style.display = memoryVisible ? 'block' : 'none';
      this.textContent = memoryVisible ? 'Ukryj zapamiƒôtane' : 'Poka≈º zapamiƒôtane';
      if (memoryVisible) {
        renderMemory();
        document.getElementById('memory-buttons').style.display = 'block';
      } else {
        document.getElementById('memory-buttons').style.display = 'none';
      }
    };


    function showAutoTimer(sec) {
      const timerDiv = document.getElementById('auto-timer');
      timerDiv.style.display = 'block';
      timerDiv.textContent = `‚è±Ô∏è ${sec}s`;
    }
    
    function hideAutoTimer() {
      document.getElementById('auto-timer').style.display = 'none';
    }

    // ...usuniƒôto obs≈Çugƒô widoczno≈õci element√≥w g≈Çosowych...

    function startAutoMode() {
      if (autoMode) return;
      autoMode = true;
      document.getElementById('auto-mode-btn').textContent = 'Wy≈ÇƒÖcz auto';
      // Ukryj przyciski odpowiedzi w trybie auto
      document.querySelector('.buttons').style.display = 'none';
      document.getElementById('undo-known-btn').style.display = 'none';
      document.getElementById('show-memory-btn').style.display = 'none';
      autoStep = 0;
      autoNextStep();
    }
    
    function stopAutoMode() {
      autoMode = false;
      document.getElementById('auto-mode-btn').textContent = 'Auto tryb';
      // Przywr√≥ƒá przyciski odpowiedzi po wy≈ÇƒÖczeniu auto
      document.querySelector('.buttons').style.display = '';
      document.getElementById('undo-known-btn').style.display = '';
      document.getElementById('show-memory-btn').style.display = '';
      hideAutoTimer();
      if (autoTimer) clearTimeout(autoTimer);
    }
    
    function autoNextStep() {
      if (!autoMode) return;
      if (autoStep === 0) {
        autoTimeLeft = 8;
        showAutoTimer(autoTimeLeft);
        autoTimer = setInterval(() => {
          autoTimeLeft--;
          showAutoTimer(autoTimeLeft);
          if (autoTimeLeft <= 0) {
            clearInterval(autoTimer);
            skipWord();
            autoStep = 1;
            autoNextStep();
          }
        }, 1000);
      } else if (autoStep === 1) {
        autoTimeLeft = 3;
        showAutoTimer(autoTimeLeft);
        autoTimer = setInterval(() => {
          autoTimeLeft--;
          showAutoTimer(autoTimeLeft);
          if (autoTimeLeft <= 0) {
            clearInterval(autoTimer);
            nextWord();
            autoStep = 0;
            autoNextStep();
          }
        }, 1000);
      }
    }
    
    document.getElementById('auto-mode-btn').onclick = function() {
      if (!autoMode) {
        startAutoMode();
        document.getElementById('lang-select-container').style.display = 'flex';
      } else {
        stopAutoMode();
        document.getElementById('lang-select-container').style.display = 'none';
      }
    };

    document.getElementById('toggle-dark-mode-btn').onclick = function() {
      const body = document.body;
      const autoBtn = document.getElementById('auto-mode-btn');
      const darkBtn = document.getElementById('toggle-dark-mode-btn');
      if (!body.classList.contains('dark-mode')) {
        body.classList.add('dark-mode');
        this.textContent = 'Tryb dzienny';
        document.getElementById('auto-timer').style.color = '#b3e0ff';
        
        // Zapisz preferencjƒô trybu ciemnego
        localStorage.setItem('slowkaDarkMode', 'true');
      } else {
        body.classList.remove('dark-mode');
        this.textContent = 'Tryb nocny';
        document.getElementById('auto-timer').style.color = '#005a9e';
        
        // Zapisz preferencjƒô trybu jasnego
        localStorage.setItem('slowkaDarkMode', 'false');
      }
    };

    document.getElementById('undo-known-btn').onclick = function() {
      if (!previous) return alert('Brak poprzedniego s≈Çowa do cofniƒôcia!');
      // Sprawd≈∫ czy previous jest w used
      const idx = used.findIndex(w => w.answer === previous.answer && w.hint === previous.hint);
      if (idx === -1) return alert('Poprzednie s≈Çowo nie by≈Ço oznaczone jako znane.');
      used.splice(idx, 1);
      setUsedWords(used);
      // Dodaj z powrotem do pool je≈õli nie ma
      if (!pool.some(w => w.answer === previous.answer && w.hint === previous.hint)) {
        pool.push(previous);
      }
      showWord();
      document.getElementById('last-word').innerHTML = 'Poprzednie cofniƒôte.';
    };

    function searchWord() {
      const query = document.getElementById('search-input').value.toLowerCase();
      const resultsDiv = document.getElementById('search-results');
      if (query.length < 2) {
        resultsDiv.innerHTML = '<p class="search-results-placeholder">Wpisz co najmniej 2 litery, aby wyszukaƒá.</p>';
        return;
      }
      const results = combinedWords.filter(word => {
        if (!word || typeof word.answer !== 'string' || typeof word.hint !== 'string') return false;
        return word.answer.toLowerCase().includes(query) || word.hint.toLowerCase().includes(query);
      });
      if (results.length === 0) {
        resultsDiv.innerHTML = '<p class="search-results-placeholder">Brak wynik√≥w.</p>';
        return;
      }
      resultsDiv.innerHTML = results.map(word => 
        `<div class="search-result-item">
          <b>${word.answer}</b>
          <p>${word.hint}</p>
        </div>`
      ).join('');
    }

    document.getElementById('search-input').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        searchWord();
      }
    });

    // --- Wake Lock API ---
    let wakeLock = null;
    
    async function requestWakeLock() {
      if ('wakeLock' in navigator) {
        try {
          wakeLock = await navigator.wakeLock.request('screen');
          wakeLock.addEventListener('release', () => {
            console.log('Wake Lock released');
            // Je≈õli jeste≈õmy w trybie auto, kontynuuj dzia≈Çanie w tle
            if (autoMode) {
              // Removed call to enableBackgroundMode();
            }
          });
        } catch (err) {
          console.log('Wake Lock request failed:', err);
        }
      }
    }

    // Ponownie aktywuj Wake Lock po wznowieniu strony
    window.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') {
        requestWakeLock();
      }
    });

    // Obs≈Çuga powiadomie≈Ñ
    // Usuniƒôto automatyczne pytanie o pozwolenie na powiadomienia przy starcie

    // Aktywuj Wake Lock na starcie
    requestWakeLock();

    // Dodaj obs≈Çugƒô Page Visibility API dla lepszego wykrywania stanu aplikacji
    document.addEventListener('visibilitychange', () => {
      if (document.hidden && autoMode) {
        console.log('Page hidden - continuing in background');
        // Removed call to enableBackgroundMode();
      } else if (!document.hidden) {
        console.log('Page visible - disabling background mode');
        // Removed call to disableBackgroundMode();
      }
    });
    

    
    // --- Inicjalizacja aplikacji ---
    // Poczekaj na za≈Çadowanie wszystkich skrypt√≥w
    window.addEventListener('load', function() {
  // Ukryj dodatkowe opcje na starcie
  document.getElementById('memory-buttons').style.display = 'none';
  document.getElementById('memory-list').style.display = 'none';
  document.getElementById('lang-select-container').style.display = 'none';
  document.getElementById('search-container').style.display = 'none';
  document.getElementById('search-results').style.display = 'none';
  document.getElementById('other-options-btn-container').style.display = 'block';
  // Dodaj przycisk i kontener do fragment√≥w jako lista po przecinku
  if (!document.getElementById('show-fragment-memory-comma-btn')) {
    const btn = document.createElement('button');
    btn.id = 'show-fragment-memory-comma-btn';
    btn.textContent = 'Poka≈º fragmenty jako listƒô';
    btn.className = 'show-fragment-memory-btn';
    btn.style.marginLeft = '8px';
    document.getElementById('memory-buttons').appendChild(btn);
    const fragList = document.createElement('div');
    fragList.id = 'fragment-memory-list-comma';
    fragList.style.display = 'none';
    fragList.style.marginTop = '8px';
    document.getElementById('memory-buttons').appendChild(fragList);
    // Dodaj przycisk "Usu≈Ñ wszystkie fragmenty" poni≈ºej listy fragment√≥w
    const clearFragmentsBtn = document.createElement('button');
    clearFragmentsBtn.id = 'clear-fragments-btn';
    clearFragmentsBtn.textContent = 'Usu≈Ñ wszystkie fragmenty';
    clearFragmentsBtn.style.marginTop = '8px';
    clearFragmentsBtn.style.display = 'none';
    document.getElementById('memory-buttons').appendChild(clearFragmentsBtn);
    let fragmentMemoryVisible = false;
    btn.onclick = function() {
      fragmentMemoryVisible = !fragmentMemoryVisible;
      fragList.style.display = fragmentMemoryVisible ? 'block' : 'none';
      clearFragmentsBtn.style.display = fragmentMemoryVisible ? 'inline-block' : 'none';
      btn.textContent = fragmentMemoryVisible ? 'Ukryj fragmenty' : 'Poka≈º fragmenty jako listƒô';
      if (fragmentMemoryVisible) {
        renderFragmentMemoryComma();
      }
    };
    clearFragmentsBtn.onclick = function() {
      if (confirm('Czy na pewno chcesz usunƒÖƒá wszystkie zapamiƒôtane fragmenty?')) {
        setFragmentMemory([]);
        renderFragmentMemoryComma();
      }
    };
  }
    // Obs≈Çuga przycisku "Inne opcje" - pokazuje/ukrywa dodatkowe opcje
    let otherOptionsVisible = false;
    document.getElementById('other-options-btn').onclick = function() {
      otherOptionsVisible = !otherOptionsVisible;
      document.getElementById('memory-buttons').style.display = otherOptionsVisible ? 'block' : 'none';
        document.getElementById('lang-select-container').style.display = 'flex';
      document.getElementById('search-container').style.display = otherOptionsVisible ? 'flex' : 'none';
      document.getElementById('search-results').style.display = otherOptionsVisible ? 'block' : 'none';
      this.textContent = otherOptionsVisible ? 'Ukryj opcje' : 'Inne opcje';
    };
      // Przywr√≥ƒá tryb ciemny je≈õli by≈Ç zapisany
      const savedDarkMode = localStorage.getItem('slowkaDarkMode');
      if (savedDarkMode === 'true') {
        document.body.classList.add('dark-mode');
        const darkBtn = document.getElementById('toggle-dark-mode-btn');
        if (darkBtn) darkBtn.textContent = 'Tryb dzienny';
      }
      
  // Inicjalizuj pakiety
  initializePackages();
      
  // ...usuniƒôto inicjalizacjƒô widoczno≈õci element√≥w g≈Çosowych...
      
      // Rejestracja Service Worker
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js')
          .then(registration => {
            console.log('Service Worker registered successfully:', registration);
          })
          .catch(error => {
            console.log('Service Worker registration failed:', error);
          });
      }
      
      // Aktywuj Wake Lock
      requestWakeLock();
      
  // ...usuniƒôto ≈Çadowanie ustawie≈Ñ jƒôzyka g≈Çosowego...
    });

    // ...usuniƒôto ca≈ÇƒÖ logikƒô g≈ÇosowƒÖ...
  </script>
</body>
</html>
